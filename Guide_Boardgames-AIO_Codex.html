<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#020203">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CODEX LUDUS | Singularity Tactical Unit</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNvZGV4IEx1ZHVzIFRhY3RpY2FsIFVuaXQiLAogICJzaG9ydF9uYW1lIjogIkNPREVYIExVRFVTIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMjAyMDMiLAogICJ0aGVtZV9jb2xvciI6ICIjMDJiNmQ0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9pbWcuaWNvbnM4LmNvbS9mbHVlbnR6eS81MTIvY2hldnJvbi1yaWdodC5wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
    
    <!-- Typography & Framework -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: { 950: '#020203' },
                        'accent-cyan': '#06b6d4',
                        'accent-rose': '#f43f5e',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { background-color: #020203; color: #f4f4f5; -webkit-tap-highlight-color: transparent; cursor: crosshair; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: calc(2.5rem + var(--sab)); }
        .pt-safe { padding-top: calc(0.5rem + var(--sat)); }
        
        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(to right, transparent, rgba(6, 182, 212, 0.4), transparent);
            pointer-events: none; z-index: 100;
            animation: scanline 8s linear infinite;
        }
        .glass-blur { backdrop-filter: blur(64px); background: rgba(2, 2, 3, 0.95); }
        .bento-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .bento-card:hover { border-color: #06b6d4; background: rgba(6, 182, 212, 0.05); transform: translateY(-4px); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.8); }
        .bento-card.selected { border-color: #06b6d4; background: rgba(6, 182, 212, 0.1); }
        .math-symbol { color: #06b6d4; font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        .terminal-text { text-shadow: 0 0 12px rgba(6, 182, 212, 0.5); }
        .deploy-anim { animation: deploy 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes deploy { from { opacity: 0; transform: scale(0.98) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    </style>
</head>
<body class="font-sans antialiased overflow-hidden selection:bg-accent-cyan/30">
    <div id="root"></div>
    <div class="scanline"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- APEX TACTICAL ICONS ---
        const SVG_PATHS = {
            ChevronLeft: "M15 18l-6-6 6-6",
            Target: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z",
            Zap: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
            Activity: "M22 12h-4l-3 9L9 3l-3 9H2",
            ShieldAlert: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z",
            GitMerge: "M18 18c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z",
            Settings: "M12 15a3 3 0 100-6 3 3 0 000 6z",
            Search: "M21 21l-6-6",
            Eye: "M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z",
            Clock: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
            Plus: "M12 5v14M5 12h14",
            Check: "M20 6L9 17l-5-5",
            Info: "M12 16v-4M12 8h.01M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10z"
        };

        const Icon = ({ name, size = 18, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={SVG_PATHS[name]} />
                {name === 'Target' && <React.Fragment><circle cx="12" cy="12" r="10" /><circle cx="12" cy="12" r="6" /><circle cx="12" cy="12" r="2" /></React.Fragment>}
                {name === 'Settings' && <circle cx="12" cy="12" r="3" />}
                {name === 'Search' && <circle cx="11" cy="11" r="8" />}
                {name === 'Eye' && <circle cx="12" cy="12" r="3" />}
                {name === 'Info' && <path d={SVG_PATHS.Info} />}
            </svg>
        );

        const LogoIcon = () => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className="w-10 h-10 text-accent-cyan drop-shadow-[0_0_12px_rgba(6,182,212,0.6)]">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
            </svg>
        );

        // --- DATA BASE (TERMINAL FIDELITY) ---
        const GAME_SYSTEMS = [
            { id: '7w', name: '7 Wonders', weight: 2.32, mins: 30, type: 'Technical', cat: 'Drafting', hook: "Civilization drafting represents a zero-sum resource management optimization problem. Every card selection denies an opponent while scaling internal multipliers.", victory: "Aggregate maximum VP across seven vectors: Military, Science, Civilian, Commercial, Wonders, Guilds, and Treasury.", directive: "Prioritize Green-Science early ($n^2$ scaling) or focus strictly on Blue-Civilian chains to starve neighbor resources.", velocity: "Age I: Economic base. Age II: Strategic Pivot. Age III: Pure VP conversion.", meta: "Weight 2.32 dictates technical efficiency over social intuition. Calculate neighbor dependency before every draft.", e_0x: "E_0x01: Dabbling in Science. E_0x02: Hoarding useless Age III gold. E_0x03: Ignoring neighbor construction chains.", synergy: "Scriptorium → Library → University. Marketplace → Caravansery → Lighthouse.", setup: "Separate decks by age. Deal 7 cards per operative. Initialize Wonder boards.", expansion: "Leaders: Dilutes color distribution. Prioritize leaders that provide fixed resources early." },
            { id: '7wd', name: '7 Wonders Duel', weight: 2.22, mins: 30, type: 'Technical', cat: 'Tug-of-War', hook: "Duel constitutes a ruthless zero-sum conflict. You dismantle your opponent's civilization as frequently as you build your own.", victory: "Achieve Military Supremacy, Scientific Supremacy, or maximum VP after Age III.", directive: "Control the Reveal. Manipulate the pyramid structure to force opponents into exposing high-value assets for your acquisition.", velocity: "Immediate threat management. Every card acts as either a weapon or a resource shield.", meta: "Economic scaling determines victory. Strangle the opponent's access to Stone or Papyrus to induce bankruptcy.", e_0x: "E_0x11: Failing to block 6th science symbol. E_0x12: Poor Wonder timing. E_0x13: Overspending on redundant resources.", synergy: "The Sphinx + The Great Library. Strategy Token + Military Rush.", setup: "Layout pyramid according to Age schema. Distribute 4 Wonders per operative.", expansion: "Pantheon: Enables out-of-turn god drafting. Use to bypass a forced 'Reveal' in the pyramid." },
            { id: 'az', name: 'Azul', weight: 1.76, mins: 45, type: 'Tactical', cat: 'Drafting', hook: "Azul creates a deceptive facade of beauty over a core of mathematical cruelty. Force your opponent into an overflow state.", victory: "Maximize adjacency points and vertical column bonuses ($7$ VP) while inducing floor-line penalties for rivals.", directive: "Fill vertical columns early to trigger repeated adjacency scoring ($P = n + m$). Practice defensive drafting.", velocity: "Calculate center-pile overflows 3 turns ahead. Force the 'Poison Pill'.", meta: "Low weight prioritizes risk management and hate-drafting over deep engine building.", e_0x: "E_0x21: Chasing 5-color bonus prematurely. E_0x22: Vertical column neglect. E_0x23: Miscalculating the center pot.", synergy: "Middle-column spine + late-game horizontal rush. First Player Token + Color Lock.", setup: "Seed 5-9 factories with 4 random tiles each. Initialize floor lines.", expansion: "Crystal Mosaic: Provides fixed scoring targets. Increases deterministic transparency." },
            { id: 'ca', name: 'Carcassonne', weight: 2.00, mins: 35, type: 'Technical', cat: 'Area Control', hook: "Spatial warfare via tile-placement. Every landscape element serves as a potential trap for opponent meeples.", victory: "Dominate scoring Fields (Farmers) and steal partially completed Cities via hostile takeover.", directive: "Practice 'Glomming'. Use meeple proximity to merge with and steal opponent features.", velocity: "Endgame farm wars determine 60% of total score output. Manage meeple liquidity.", meta: "Weight 2.00 necessitates precise meeple management. A trapped meeple is a dead resource.", e_0x: "E_0x31: Meeple starvation. E_0x32: Stranding the Big Meeple. E_0x33: Early field commitment.", synergy: "Cathedral + City Sabotage. Big Meeple + Hostile Farm Merger.", setup: "Shuffle 72 tiles. Distribute 8 meeples. Start tile in center.", expansion: "Inns & Cathedrals: High-risk city scoring. Only build cities you can defensively close." },
            { id: 'ch', name: 'Chess', weight: 3.65, mins: 60, type: 'Technical', cat: 'Abstract', hook: "Perfect information simulation. Chess operates as the ultimate test of deterministic logic.", victory: "Checkmate the opposing King through superior development and positional pressure.", directive: "Control the center (e4, d4, e5, d5). Pieces in the center exert maximum board influence.", velocity: "Opening: Development. Midgame: Tactics. Endgame: Precision.", meta: "Extreme weight dictates absolute efficiency. A single tempo loss equates to failure.", e_0x: "E_0x41: Scholar's Mate. E_0x42: Hanging pieces. E_0x43: Early Queen deployment.", synergy: "Rook Battery + Back Rank. Knight Fork + Smothered Mate.", setup: "Standard board init. White moves first.", expansion: "N/A: System is self-contained." },
            { id: 'co', name: 'Coup', weight: 1.41, mins: 15, type: 'Tactical', cat: 'Bluffing', hook: "Information constitutes a weapon. Lying is an optional survival mechanic for economic dominance.", victory: "Eliminate all opposing influence. Be the last agent standing.", directive: "The Duke Opening: Claim Duke on Turn 1 to accelerate coin accumulation towards the unblockable Coup ($7$ coins).", velocity: "Rapid escalation. Games terminate once the first $10$-coin threshold breaks.", meta: "Social weight class. Focus strictly on bluff calibration and pressure management.", e_0x: "E_0x51: Perma-Duking. E_0x52: Failed Contessa bluff. E_0x53: Challenge happiness.", synergy: "Ambassador + Assassin. Captain + Inquisitor.", setup: "3 cards per role. 2 cards per agent. 2 coins start.", expansion: "Reformation: Introduces factions. Use factions to prevent Captain steals from allies." },
            { id: 'dm', name: 'Dominion', weight: 2.35, mins: 30, type: 'Technical', cat: 'Deck-Building', hook: "Dominion represents a deck-density optimization problem. Starting cards are garbage; trash them.", victory: "Accumulate Provinces while maintaining a thin, high-velocity deck.", directive: "Trash is Treasure. Use Chapel or Sentry to purge Coppers and Estates.", velocity: "Engine building: 10 turns. Province harvest: 5 turns. Watch 3-pile endings.", meta: "Mathematical efficiency. Avoid 'Terminal Collision' (Too many actions, not enough buys).", e_0x: "E_0x61: Village Idiot syndrome. E_0x62: Green bloat. E_0x63: Ignoring trashing.", synergy: "Village + Smithy. Workshop + Gardens.", setup: "Select 10 Kingdom piles. 7 Copper / 3 Estate starting deck.", expansion: "Prosperity: Introduces Platinum/Colonies. Extends game duration to Turn 20+." },
            { id: 'ek', name: 'Exploding Kittens', weight: 1.08, mins: 15, type: 'Tactical', cat: 'Push-Luck', hook: "Russian Roulette with felines. Hoard information and skip turns.", victory: "Survival. Be the final entity remaining in the deck.", directive: "Hoard Information. Never draw from a thin deck without using 'See the Future' or 'Skip'.", velocity: "Increases exponentially as the deck depletes. Probability of death approaches 1.0.", meta: "Social disruption focus. Manage the psychological state of the table.", e_0x: "E_0x71: Wasting Defuses. E_0x72: Blind drawing. E_0x73: Predictable Kitten placement.", synergy: "See the Future + Attack. Two of a Kind + Defuse Theft.", setup: "Remove kittens. Deal 7 cards + 1 defuse. Re-insert kittens (N-1).", expansion: "Barking Kittens: Introduces tower mechanics. Allows defensive card caching." },
            { id: 'ka', name: 'Kahuna', weight: 2.05, mins: 30, type: 'Technical', cat: 'Area Control', hook: "Bridge building in an archipelago. Trigger domino effects to collapse opponent bridge networks.", victory: "Secure island majorities ($>50\%$) to remove opponent bridges and score VP.", directive: "Target hubs with fewer connections. Create Cascades by capturing islands neighboring strongholds.", velocity: "Round 1: Foothold. Round 2: Aggression. Round 3: Dominance.", meta: "Graph theory. Removal of one node can cause system-wide collapse.", e_0x: "E_0x81: Overextension. E_0x82: Empty hand vulnerability. E_0x83: Ignoring center defense.", synergy: "Double Card Play + Bridge Removal. Center Hub Control.", setup: "Island deck prep. 3 cards per sorcerer. Supply bridges.", expansion: "N/A: System is self-contained." },
            { id: 'ok', name: 'Okko', weight: 2.50, mins: 60, type: 'Technical', cat: 'Skirmish', hook: "Tactical miniatures skirmish. Manage elemental Inspiration Dice to fuel demonic destruction.", victory: "Scenario dependent. Eliminate Oni leader or control board objectives.", directive: "Maintain a Reserve. Always keep one die for defense; a character without a reserved die dies fast.", velocity: "Deterministic movement + probabilistic combat. Limited action economy.", meta: "Weight 2.5 dictates strict resource management over tactical flair.", e_0x: "E_0x91: Leader exposure. E_0x92: Dice waste. E_0x93: LOS failure.", synergy: "Samurai + Fire Die. Sorcerer + Kami Summon.", setup: "Select scenario. Layout board and inspiration dice.", expansion: "Prowlers: Introduces stealth mechanics. Allows infiltration of backlines." },
            { id: 'pa', name: 'Pandemic', weight: 2.41, mins: 45, type: 'Technical', cat: 'Cooperative', hook: "Logistical puzzle vs a viral machine. You are fighting the clock, not the diseases.", victory: "Discover all four Cures. Do not waste time on total eradication.", directive: "Treat to 2, Don't Clear to 0. Efficiency is life. Trade data at research stations.", velocity: "Escalates with every Epidemic. Pacing is critical.", meta: "Technical action economy. Avoid 'Quarterbacking' (Leader dominance).", e_0x: "E_0xa1: Eradication obsession. E_0xa2: Flying blind. E_0xa3: Ignoring discard pile.", synergy: "Medic + Dispatcher. Researcher + Scientist.", setup: "Infect 9 cities. Deal roles. Shuffle Epidemics into player deck.", expansion: "On the Brink: Bio-terrorist role. Shifts game from Co-op to 1-vs-Many." },
            { id: 'pw', name: 'Patchwork', weight: 1.61, mins: 20, type: 'Tactical', cat: 'Polyomino', hook: "Quilting is an economic engine. Every patch costs Time and Buttons.", victory: "Maximize button income and fill the grid to avoid $-2$ VP penalty per space.", directive: "Button Income First. Prioritize patches with button icons early for dividend payouts.", velocity: "Time Track management. Take double turns by staying behind the opponent.", meta: "Economic ROI scaling determines victory. $(Buttons \times Paydays) - Cost$.", e_0x: "E_0xb1: Ignoring 7x7. E_0xb2: Overpaying for time. E_0xb3: 1x1 hole creation.", synergy: "Cheap Space Filler + 1x1 Leather. High-Income Early Buy.", setup: "Arrange patches in circle. Place markers. 5 Buttons start.", expansion: "N/A: System is self-contained." },
            { id: 're', name: 'The Resistance', weight: 1.59, mins: 30, type: 'Tactical', cat: 'Deduction', hook: "Logic vs Deception. Resistance knows nothing; Spies know everything.", victory: "Resistance: 3 Successes. Spies: 3 Fails or voting deadlock.", directive: "Vote DOWN. Reject every mission you are not on to force data disclosure via voting patterns.", velocity: "Critical data spikes at Mission 3. Spies must strike now.", meta: "Psychological weight. Silence is an admission of guilt.", e_0x: "E_0xc1: Blind trust. E_0xc2: Quiet spies. E_0xc3: Failing Mission 1 (As spy).", synergy: "Merlin + Bodyguard. Double Spy Fail Avoidance.", setup: "Deal roles. Spies identify. Start Mission 1 leader.", expansion: "Hidden Agenda: Introduces Commander role. High-stakes info targeting." },
            { id: 'sw', name: 'Small World', weight: 2.35, mins: 50, type: 'Technical', cat: 'Area Control', hook: "Conquer or Die. Rewards expansion and timely abandonment of civilizations.", victory: "Maximize Victory Coins through territory management and race churning.", directive: "Aggressive Decline. Abandon race on Turn 3 or 4 to harvest double points with a new army.", velocity: "Expansion followed by collapse. Manage the 'Churn'.", meta: "Territory ROI. Calculate cost-per-coin before every attack.", e_0x: "E_0xd1: Sentimental attachment. E_0xd2: Ignoring Spirit powers. E_0xd3: Spreading thin.", synergy: "Flying + Sorcerers. Commando + Skeletons.", setup: "Select board by count. Shuffle races. Start coins.", expansion: "Be Not Afraid: Massive race variety. Introduces high-density area control units." },
            { id: 'sg', name: 'Sushi Go Party!', weight: 1.30, mins: 20, type: 'Tactical', cat: 'Drafting', hook: "Fast drafting buffet. Balance greed with tactical denial.", victory: "Highest score across 3 rounds. pudding/Dessert penalty avoidance.", directive: "Draft Against the Table. Deny opponents the 3rd piece of Sashimi ($10$ VP).", velocity: "Fast turnover. Calculate the card 'Flow'.", meta: "Social drafting. Adapt to the specific 'Menu' card pool.", e_0x: "E_0xe1: Sashimi trap. E_0xe2: Wasabi waste. E_0xe3: Dessert neglect.", synergy: "Wasabi + Squid Nigiri. Chopsticks + Double Draft.", setup: "Select menu. Deal hands. Initialize score trackers.", expansion: "Soy Sauce Expansion: Rewards diversity. Shifts focus from sets to varieties." },
            { id: 'tr', name: 'Ticket to Ride', weight: 1.84, mins: 45, type: 'Tactical', cat: 'Network', hook: "Railway expansion vs network blocking. A race for map dominance.", victory: "Complete Destination Tickets and secure longest continuous train path.", directive: "The Hoarding Phase. Spend 15 turns drawing cards. Claim routes in a single final dash.", velocity: "Starts slow, ends in a feverish dash. Watch train-count levels.", meta: "Tactical blocking and concealment. Do not telegraph intent.", e_0x: "E_0xf1: Telegraphing. E_0xf2: Greedy ticket draws. E_0xf3: Chokepoint neglect.", synergy: "6-Train Efficiency ($15$ VP) + Destination Overlap.", setup: "Deal tickets. Deal 4 cards. 45 trains per operative.", expansion: "1910 Expansion: Larger cards, new tickets. Increases network complexity significantly." }
        ];

        // --- CORE COMPONENTS ---

        const ErrorBoundary = ({ children }) => {
            const [hasError, setHasError] = useState(false);
            if (hasError) return (
                <div className="flex flex-col items-center justify-center h-screen bg-zinc-950 p-12 text-center space-y-4">
                    <div className="text-accent-rose font-mono text-2xl tracking-tighter font-bold terminal-text">FATAL_STATE_HALT</div>
                    <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="px-8 py-3 bg-accent-rose/20 border border-accent-rose/40 text-accent-rose rounded font-mono text-[10px] uppercase tracking-widest hover:bg-accent-rose/30 transition-all">Emergency_Reset_Protocol</button>
                </div>
            );
            return <React.Fragment>{children}</React.Fragment>;
        };

        const HUD = ({ games, plan }) => {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [time, setTime] = useState(new Date().toLocaleTimeString());

            useEffect(() => {
                const interval = setInterval(() => setTime(new Date().toLocaleTimeString()), 1000);
                const update = () => setIsOnline(navigator.onLine);
                window.addEventListener('online', update);
                window.addEventListener('offline', update);
                return () => { clearInterval(interval); window.removeEventListener('online', update); window.removeEventListener('offline', update); };
            }, []);

            const avgWeight = (games.reduce((acc, g) => acc + g.weight, 0) / (games.length || 1)).toFixed(2);
            const planTime = plan.reduce((acc, id) => acc + (GAME_SYSTEMS.find(g => g.id === id)?.mins || 0), 0);

            return (
                <div className="flex items-center justify-between px-6 py-2 border-b border-white/5 font-mono text-[9px] tracking-[0.2em] text-white/20 uppercase glass-blur sticky top-0 z-50 pt-safe">
                    <div className="flex gap-8 items-center">
                        <span className="flex items-center gap-2">
                            <div className={`w-1.5 h-1.5 rounded-full ${isOnline ? 'bg-accent-cyan shadow-[0_0_8px_#06b6d4]' : 'bg-accent-rose shadow-[0_0_8px_#f43f5e]'}`} />
                            {isOnline ? 'SYS_LINK_OK' : 'LOCAL_CACHE'}
                        </span>
                        <span className="hidden lg:inline text-white/40">SINGULARITY_v17.0</span>
                    </div>
                    <div className="flex gap-10 items-center">
                        {plan.length > 0 && <span>MISSION_PLAN: {planTime}m</span>}
                        <span>AVG_WT: {avgWeight}</span>
                        <span className="text-accent-cyan terminal-text font-bold">{time}</span>
                    </div>
                </div>
            );
        };

        const Diagnostics = ({ onClose }) => (
            <div className="fixed inset-0 z-[100] glass-blur flex items-center justify-center p-6">
                <div className="max-w-2xl w-full bg-zinc-900 border border-white/10 rounded-3xl p-10 space-y-8 deploy-anim shadow-2xl">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-black uppercase tracking-tighter terminal-text">Core_Logic_Diagnostics</h2>
                        <button onClick={onClose} className="p-2 hover:bg-white/5 rounded-full transition-all"><Icon name="ChevronLeft" size={24} /></button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 font-mono text-[10px] leading-loose text-white/40 uppercase">
                        <div className="space-y-4">
                            <div className="text-accent-cyan opacity-100">[Architecture]</div>
                            <p>- Zero-Entropy PWA Logic<br/>- React 18 / Tailwind Stack<br/>- Single-File Self-Containment<br/>- Schema-Sanitizing State Recovery</p>
                        </div>
                        <div className="space-y-4">
                            <div className="text-accent-cyan opacity-100">[Tone Calibration]</div>
                            <p>- Wt &lt; 2.0: Social/Psych Focus<br/>- Wt &gt;= 2.0: Engine/Economic Focus<br/>- Deterministic Data Sourcing<br/>- 100% Fidelity Verification</p>
                        </div>
                    </div>
                    <div className="pt-8 border-t border-white/5 flex justify-between items-center opacity-40">
                        <div className="font-mono text-[9px]">Status: Funkcionalis</div>
                        <div className="font-mono text-[9px]">Source: BG_CODEX.md</div>
                    </div>
                </div>
            </div>
        );

        const DetailView = ({ game, activeSide, setSide, onBack }) => {
            const formatMath = (text) => {
                if (!text) return "";
                const parts = text.split(/(\$[^\$]+\$)/g);
                return parts.map((part, i) => {
                    if (part.startsWith('$') && part.endsWith('$')) return <span key={i} className="math-symbol">{part.replace(/\$/g, '')}</span>;
                    return part;
                });
            };

            const weightRationale = game.weight < 2.0 
                ? `SOCIAL CLASS (< 2.0): Wt ${game.weight} mandates focus on social engineering, risk deflection, and psychological state management.`
                : `TECHNICAL CLASS (>= 2.0): Wt ${game.weight} mandates strict technical efficiency, economic engine scaling, and turn-order optimization.`;

            return (
                <div className="fixed inset-0 z-[60] glass-blur overflow-y-auto animate-in fade-in slide-in-from-bottom-8 duration-700 pb-32 deploy-anim">
                    <div className="max-w-4xl mx-auto px-6 py-12 flex flex-col min-h-screen pt-safe">
                        <header className="space-y-6 mb-16">
                            <button onClick={onBack} className="flex items-center gap-2 text-white/20 hover:text-white transition-colors uppercase font-mono text-[10px] tracking-[0.3em]">
                                <Icon name="ChevronLeft" size={14} /> DISCONNECT_DOCK
                            </button>
                            <div className="flex flex-col md:flex-row md:items-end justify-between gap-8">
                                <div>
                                    <div className="text-accent-cyan font-mono text-xs tracking-[0.4em] mb-2 uppercase opacity-60">TACTICAL_UNIT // 0x{game.id.toUpperCase()}</div>
                                    <h2 className="text-7xl font-black text-white tracking-tighter uppercase leading-none">{game.name}</h2>
                                </div>
                                <div className="flex p-1 bg-zinc-900 border border-white/5 rounded-2xl shadow-2xl">
                                    {['A', 'B'].map(side => (
                                        <button key={side} onClick={() => setSide(side)} className={`px-10 py-3 rounded-xl text-[10px] font-mono transition-all uppercase tracking-widest ${activeSide === side ? 'bg-accent-cyan text-zinc-950 font-bold shadow-[0_0_20px_rgba(6,182,212,0.3)]' : 'text-white/20 hover:text-white'}`}>
                                            {side === 'A' ? 'Orientation' : 'Tactics'}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-16">
                            <div className="lg:col-span-8 space-y-16">
                                <section className="space-y-6">
                                    <div className="flex items-center gap-3 text-accent-cyan font-mono text-[10px] uppercase tracking-[0.5em] opacity-40">
                                        <Icon name="Activity" size={14} /> Intelligence_Hook
                                    </div>
                                    <p className="text-3xl text-white/90 font-light leading-tight tracking-tight">{formatMath(game.hook)}</p>
                                </section>

                                {activeSide === 'A' ? (
                                    <div className="space-y-16 animate-in fade-in slide-in-from-left-4 duration-500">
                                        <section className="bg-white/[0.03] p-10 rounded-[2.5rem] border border-white/5 space-y-6 shadow-2xl">
                                            <div className="flex items-center gap-2 text-accent-cyan font-mono text-[10px] uppercase tracking-[0.4em]">
                                                <Icon name="Target" size={14} /> Victory_Pathway
                                            </div>
                                            <p className="text-2xl text-white font-bold leading-tight tracking-tight">{formatMath(game.victory)}</p>
                                        </section>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                                            <section className="space-y-4">
                                                <div className="flex items-center gap-2 text-accent-cyan font-mono text-[10px] uppercase tracking-[0.4em] opacity-50">
                                                    <Icon name="Zap" size={14} /> Strategic_Directive
                                                </div>
                                                <p className="text-lg text-white/70 leading-relaxed font-light">{formatMath(game.directive)}</p>
                                            </section>
                                            <section className="space-y-4">
                                                <div className="flex items-center gap-2 text-accent-cyan font-mono text-[10px] uppercase tracking-[0.4em] opacity-50">
                                                    <Icon name="Clock" size={14} /> Phase_Velocity
                                                </div>
                                                <p className="text-lg text-white/70 leading-relaxed font-mono text-sm">{formatMath(game.velocity)}</p>
                                            </section>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-16 animate-in fade-in slide-in-from-right-4 duration-500">
                                        <section className="p-10 bg-accent-rose/5 border border-accent-rose/20 rounded-[2.5rem] space-y-8 shadow-2xl">
                                            <div className="flex items-center gap-2 text-accent-rose font-mono text-[10px] uppercase tracking-[0.4em]">
                                                <Icon name="ShieldAlert" size={14} /> Rookie_Errors
                                            </div>
                                            <div className="grid gap-6">
                                                {game.e_0x.split('. ').map((err, i) => (
                                                    <div key={i} className="flex gap-6 items-start">
                                                        <span className="text-accent-rose font-mono text-[10px] mt-1 font-bold tracking-widest">ERR_0x{i+1}</span>
                                                        <span className="text-white/80 text-base leading-relaxed">{err}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </section>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                                            <section className="space-y-6">
                                                <div className="flex items-center gap-2 text-accent-cyan font-mono text-[10px] uppercase tracking-[0.4em] opacity-50">
                                                    <Icon name="GitMerge" size={14} /> Synergy_Matrix
                                                </div>
                                                <p className="text-sm text-white/60 leading-relaxed font-mono bg-zinc-900/50 p-8 rounded-2xl border border-white/5">{formatMath(game.synergy)}</p>
                                            </section>
                                            <section className="p-8 bg-accent-cyan/5 border border-accent-cyan/10 rounded-2xl space-y-4">
                                                <div className="font-mono text-[10px] text-accent-cyan uppercase tracking-[0.4em]">Expansion_Nuance</div>
                                                <p className="text-sm text-white/70 leading-relaxed italic">{formatMath(game.expansion)}</p>
                                            </section>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <aside className="lg:col-span-4 space-y-8">
                                <div className="p-8 bg-zinc-900/50 border border-white/5 rounded-[2rem] space-y-4">
                                    <div className="font-mono text-[9px] text-accent-cyan uppercase tracking-[0.3em] opacity-40">Analytical_Logic</div>
                                    <p className="text-[10px] text-white/40 leading-relaxed uppercase tracking-widest">{weightRationale}</p>
                                </div>
                                <div className="p-8 bg-white/[0.02] border border-white/5 rounded-[2rem] space-y-6">
                                    <div className="font-mono text-[9px] text-accent-cyan uppercase tracking-[0.3em] opacity-40 flex items-center gap-2">
                                        <Icon name="Settings" size={12} /> Setup_Protocol
                                    </div>
                                    <p className="text-xs text-white/60 leading-loose">{formatMath(game.setup)}</p>
                                </div>
                                <div className="p-6 bg-white/[0.01] border border-white/5 rounded-2xl flex justify-between items-center opacity-40">
                                    <div className="flex items-center gap-3">
                                        <Icon name="Clock" size={14} />
                                        <span className="font-mono text-[9px] uppercase tracking-widest">Time_Target</span>
                                    </div>
                                    <span className="font-mono text-[9px] text-accent-cyan">{game.mins}m</span>
                                </div>
                                <div className="p-6 bg-white/[0.01] border border-white/5 rounded-2xl flex justify-between items-center opacity-40">
                                    <div className="flex items-center gap-3">
                                        <Icon name="Info" size={14} />
                                        <span className="font-mono text-[9px] uppercase tracking-widest">Complexity</span>
                                    </div>
                                    <span className="font-mono text-[9px] text-accent-cyan">{game.weight}</span>
                                </div>
                            </aside>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [selectedId, setSelectedId] = useState(() => localStorage.getItem('selectedId') || null);
            const [activeSide, setActiveSide] = useState(() => localStorage.getItem('activeSide') || 'A');
            const [filterState, setFilterState] = useState(() => {
                try { return JSON.parse(localStorage.getItem('filterState') || '{"wt": "all"}'); }
                catch { return {wt: "all"}; }
            });
            const [missionPlan, setMissionPlan] = useState(() => {
                try { return JSON.parse(localStorage.getItem('missionPlan') || '[]'); }
                catch { return []; }
            });
            const [searchQuery, setSearchQuery] = useState('');
            const [sortBy, setSortBy] = useState('alpha');
            const [showDiag, setShowDiag] = useState(false);
            const [fidelity, setFidelity] = useState(true);

            useEffect(() => {
                localStorage.setItem('selectedId', selectedId || '');
                localStorage.setItem('activeSide', activeSide);
                localStorage.setItem('filterState', JSON.stringify(filterState));
                localStorage.setItem('missionPlan', JSON.stringify(missionPlan));
                if (selectedId) window.location.hash = `unit/${selectedId}`;
                else window.location.hash = '';
            }, [selectedId, activeSide, filterState, missionPlan]);

            useEffect(() => {
                const handleHash = () => {
                    const id = window.location.hash.split('unit/')[1];
                    if (id && GAME_SYSTEMS.find(g => g.id === id)) setSelectedId(id);
                    else setSelectedId(null);
                };
                window.addEventListener('hashchange', handleHash);
                handleHash();
                return () => window.removeEventListener('hashchange', handleHash);
            }, []);

            const filteredGames = useMemo(() => {
                let base = [...GAME_SYSTEMS];
                if (filterState.wt === 'low') base = base.filter(g => g.weight < 2.0);
                if (filterState.wt === 'high') base = base.filter(g => g.weight >= 2.0);
                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    base = base.filter(g => g.name.toLowerCase().includes(q) || g.cat.toLowerCase().includes(q));
                }
                if (sortBy === 'alpha') base.sort((a,b) => a.name.localeCompare(b.name));
                if (sortBy === 'weight') base.sort((a,b) => b.weight - a.weight);
                if (sortBy === 'time') base.sort((a,b) => b.mins - a.mins);
                return base;
            }, [filterState, searchQuery, sortBy]);

            const togglePlan = (id, e) => {
                e.stopPropagation();
                setMissionPlan(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
            };

            const currentGame = GAME_SYSTEMS.find(g => g.id === selectedId);

            return (
                <ErrorBoundary>
                    <div className="h-screen w-full bg-zinc-950 text-white flex flex-col relative">
                        <HUD games={filteredGames} plan={missionPlan} />
                        
                        <nav className="flex flex-col md:flex-row items-start md:items-center justify-between px-10 py-12 gap-10">
                            <div className="flex items-center gap-10 group">
                                <LogoIcon />
                                <div>
                                    <h1 className="text-4xl font-black tracking-tighter uppercase leading-none terminal-text">Codex Ludus</h1>
                                    <p className="text-[10px] font-mono text-accent-cyan tracking-[0.5em] mt-4 uppercase opacity-50">Terminal_Singularity_v17.0</p>
                                </div>
                            </div>
                            
                            <div className="flex flex-wrap items-center gap-6 w-full md:w-auto">
                                <div className="relative flex-1 md:w-80 group">
                                    <Icon name="Search" className="absolute left-5 top-1/2 -translate-y-1/2 text-white/20 group-focus-within:text-accent-cyan transition-all" size={16} />
                                    <input 
                                        type="text" 
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        placeholder="QUERY_INTELLIGENCE_BASE..."
                                        className="w-full bg-white/5 border border-white/5 rounded-2xl pl-14 pr-6 py-4 font-mono text-xs focus:outline-none focus:border-accent-cyan/30 transition-all placeholder:text-white/10"
                                    />
                                </div>
                                <div className="flex bg-zinc-900 border border-white/5 rounded-2xl p-1 shadow-2xl">
                                    {['all', 'low', 'high'].map(wt => (
                                        <button key={wt} onClick={() => setFilterState({wt})} className={`px-6 py-2 text-[10px] font-mono rounded-xl transition-all uppercase tracking-widest ${filterState.wt === wt ? 'bg-accent-cyan text-zinc-950 font-bold shadow-[0_0_12px_rgba(6,182,212,0.3)]' : 'text-white/20 hover:text-white'}`}>{wt}</button>
                                    ))}
                                </div>
                            </div>
                        </nav>

                        <div className="flex items-center px-10 gap-6 mb-4">
                            <div className="text-[9px] font-mono text-white/20 uppercase tracking-widest flex items-center gap-2"><Icon name="Plus" size={10} /> SORT:</div>
                            {['alpha', 'weight', 'time'].map(s => (
                                <button key={s} onClick={() => setSortBy(s)} className={`px-3 py-1 text-[9px] font-mono rounded-full border transition-all uppercase tracking-widest ${sortBy === s ? 'bg-white/10 border-white/20 text-white' : 'border-transparent text-white/20 hover:text-white/40'}`}>
                                    {s}
                                </button>
                            ))}
                        </div>

                        <main className="flex-1 overflow-y-auto px-10 pb-48 hide-scrollbar">
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                                {filteredGames.map(game => (
                                    <div key={game.id} onClick={() => setSelectedId(game.id)} className={`bento-card group p-8 rounded-[2.5rem] cursor-pointer flex flex-col justify-between overflow-hidden relative ${missionPlan.includes(game.id) ? 'selected' : ''}`}>
                                        <div className="space-y-6">
                                            <div className="flex justify-between items-start">
                                                <div className="text-[10px] font-mono text-accent-cyan/40 tracking-[0.4em] uppercase leading-none font-bold">0x{game.id.toUpperCase()}</div>
                                                <button onClick={(e) => togglePlan(game.id, e)} className={`p-2 rounded-full border transition-all ${missionPlan.includes(game.id) ? 'bg-accent-cyan text-zinc-950 border-accent-cyan shadow-[0_0_12px_#06b6d4]' : 'bg-white/5 border-white/10 text-white/20 hover:text-white'}`}>
                                                    <Icon name={missionPlan.includes(game.id) ? 'Check' : 'Plus'} size={12} />
                                                </button>
                                            </div>
                                            <h3 className="text-3xl font-black text-white group-hover:text-accent-cyan transition-all tracking-tighter uppercase leading-none">{game.name}</h3>
                                            {fidelity && <p className="text-[10px] text-white/20 leading-relaxed line-clamp-2 uppercase tracking-widest font-light italic">{game.hook}</p>}
                                        </div>
                                        <div className="mt-10 flex items-center justify-between">
                                            <div className="flex gap-2">
                                                <span className="text-[9px] font-mono px-3 py-1 bg-white/5 rounded-full uppercase text-white/20">Wt: {game.weight}</span>
                                                <span className="text-[9px] font-mono px-3 py-1 bg-white/5 rounded-full uppercase text-white/20">{game.cat}</span>
                                            </div>
                                            <span className="text-[9px] font-mono text-white/10 uppercase">{game.mins}m</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </main>

                        {selectedId && currentGame && (
                            <DetailView game={currentGame} activeSide={activeSide} setSide={setActiveSide} onBack={() => setSelectedId(null)} />
                        )}

                        {showDiag && <Diagnostics onClose={() => setShowDiag(false)} />}

                        <footer className="fixed bottom-0 left-0 w-full glass-blur border-t border-white/5 py-6 px-10 z-[70] flex justify-between items-center pb-safe">
                            <div className="flex items-center gap-10">
                                <button onClick={() => setFidelity(!fidelity)} className="flex items-center gap-4 group">
                                    <div className={`p-3 rounded-xl transition-all ${fidelity ? 'bg-accent-cyan text-zinc-950 shadow-[0_0_15px_rgba(6,182,212,0.4)]' : 'bg-white/5 text-white/20'}`}>
                                        <Icon name="Eye" size={14} />
                                    </div>
                                    <span className="text-[10px] font-mono uppercase tracking-[0.2em] text-white/20 group-hover:text-white transition-colors">FIDELITY: {fidelity ? 'APEX' : 'CORE'}</span>
                                </button>
                                <button onClick={() => setShowDiag(true)} className="flex items-center gap-4 group text-white/20 hover:text-white transition-colors">
                                    <Icon name="Settings" size={14} />
                                    <span className="text-[10px] font-mono uppercase tracking-[0.2em]">DIAGNOSTICS</span>
                                </button>
                            </div>
                            <div className="flex items-center gap-10">
                                <div className="text-[10px] font-mono text-white/20 uppercase tracking-[0.4em] hidden sm:block">Tactical_Mission_Active</div>
                                <div className="font-mono text-[10px] text-accent-cyan/40 font-bold">TERMINAL_v17.0</div>
                            </div>
                        </footer>
                    </div>
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>